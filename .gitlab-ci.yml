stages:
  - build
  - test
  - tempDeploy
  - deploy

variables:
  PROJECT: ci-ec-auth

# build:
#   stage: build
#   script:
#     - docker build -t $PROJECT .

# lint:
#   stage: test
#   script:
#     - docker run -l $PROJECT $PROJECT sh -c "npm run ci-lint"
#     - docker container prune --filter label=$PROJECT -f

# test:
#   stage: test
#   script:
#     - docker run -l $PROJECT $PROJECT sh -c "npm run ci-test"
#     - docker container prune --filter label=$PROJECT -f

# cleanup:
#   stage: test
#   script:
#     - docker rmi $PROJECT
#   needs: ["lint", "test"]


deployDatabase:
  stage: tempDeploy
  script:
    - microk8s kubectl apply -f ./k8s/mysql-pv.yaml
    - microk8s kubectl apply -f ./k8s/mysql-pvc.yaml
    - microk8s kubectl apply -f ./k8s/mysql-deployment.yaml
    # - microk8s kubectl apply -f ./k8s/persistence_volume.yaml
    - microk8s kubectl apply -f ./k8s/mysql-service.yaml
    # - microk8s kubectl apply -f ./k8s/mysql-ingress.yaml
    - microk8s kubectl apply -f ./k8s/node-deployment.yaml
    - microk8s kubectl apply -f ./k8s/node-service.yaml
    - microk8s kubectl rollout restart deployment ec-auth-deployment


deploy:
  stage: deploy
  only:
      - production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
